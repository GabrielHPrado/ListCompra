<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a6ee0;
        }

        h1 {
            color: #4a6ee0;
            font-size: 1.6rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.85rem;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            flex: 1;
            padding: 14px;
            border: none;
            background: none;
            font-weight: 600;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn.active {
            background-color: #4a6ee0;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background-color: #f0f3ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .filters {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 140px;
        }

        label {
            display: block;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background-color: white;
            color: #333;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4a6ee0;
            box-shadow: 0 0 0 2px rgba(74, 110, 224, 0.2);
        }

        .buttons {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: #4a6ee0;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background-color: #3a5bc7;
        }

        .btn-secondary {
            background-color: #f0f3ff;
            color: #4a6ee0;
            border: 1px solid #d0d9ff;
        }

        .btn-secondary:hover {
            background-color: #e1e8ff;
        }

        .btn-danger {
            background-color: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background-color: #ff3742;
        }

        .btn-success {
            background-color: #2ed573;
            color: white;
        }

        .btn-success:hover {
            background-color: #25c46b;
        }

        .btn-warning {
            background-color: #ffa502;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e69500;
        }

        .btn-info {
            background-color: #00d2d3;
            color: white;
        }

        .btn-info:hover {
            background-color: #00b8b9;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.75rem;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #4a6ee0;
            color: #4a6ee0;
        }

        .btn-outline:hover {
            background-color: #f0f3ff;
        }

        #formulario {
            background-color: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .form-title {
            font-size: 1.1rem;
            color: #4a6ee0;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 140px;
        }

        #categorias-container {
            background-color: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .categorias-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .categoria-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: #f0f3ff;
            color: #4a6ee0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .categoria-tag .remove-cat {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .categoria-tag .remove-cat:hover {
            background-color: rgba(255, 71, 87, 0.1);
        }

        #lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #4a6ee0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .item-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: #333;
            flex: 1;
        }

        .item-category {
            background-color: #f0f3ff;
            color: #4a6ee0;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .item-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            flex: 1;
        }

        .detail {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #555;
        }

        .detail i {
            color: #4a6ee0;
            width: 14px;
            font-size: 0.75rem;
        }

        .item-month {
            background-color: #fff8e1;
            color: #e6b000;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 8px;
            align-self: flex-start;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .card-actions .btn {
            padding: 6px 10px;
            font-size: 0.75rem;
            flex: 1;
        }

        .total-container {
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            color: #4a6ee0;
            font-size: 1rem;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #888;
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ccc;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .menu-acoes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .menu-acoes .btn {
            flex: 1;
            min-width: 120px;
        }

        .relatorios-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .graficos-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .grafico-card {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .grafico-card h3 {
            font-size: 1rem;
            color: #4a6ee0;
            margin-bottom: 15px;
            text-align: center;
        }

        .resumo-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .resumo-card {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .resumo-card h4 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .resumo-card .valor {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a6ee0;
        }

        .resumo-card .detalhe {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        .file-input-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            text-align: center;
            border: 2px dashed #ddd;
        }

        .file-input-container.dragover {
            border-color: #4a6ee0;
            background-color: #f0f3ff;
        }

        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .file-input-label i {
            font-size: 2rem;
            color: #4a6ee0;
        }

        .file-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            #lista {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .resumo-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 600px) {
            #lista {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .btn {
                padding: 9px 12px;
                font-size: 0.8rem;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .menu-acoes {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 12px;
            }
            
            .item-name {
                font-size: 0.9rem;
            }
            
            .item-details {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-shopping-cart"></i> Lista de Compras Inteligente</h1>
            <p class="subtitle">Gerencie suas compras, visualize relatórios e exporte dados</p>
        </header>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="abrirTab('lista-tab')">
                <i class="fas fa-list"></i> Lista
            </button>
            <button class="tab-btn" onclick="abrirTab('relatorios-tab')">
                <i class="fas fa-chart-bar"></i> Relatórios
            </button>
            <button class="tab-btn" onclick="abrirTab('import-export-tab')">
                <i class="fas fa-file-export"></i> Importar/Exportar
            </button>
        </div>

        <!-- TAB 1: LISTA DE COMPRAS -->
        <div id="lista-tab" class="tab-content active">
            <div class="menu-acoes">
                <button class="btn btn-secondary" onclick="mostrarFormulario()">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
                <button class="btn btn-outline" onclick="mostrarGerenciarCategorias()">
                    <i class="fas fa-tags"></i> Categorias
                </button>
            </div>

            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filtroMes"><i class="far fa-calendar-alt"></i> Mês</label>
                        <select id="filtroMes">
                            <option value="">Todos os meses</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filtroCat"><i class="fas fa-tags"></i> Categoria</label>
                        <select id="filtroCat">
                            <option value="Tudo">Todas as categorias</option>
                        </select>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" onclick="mostrarItens()">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                </div>
            </div>

            <div id="formulario" style="display:none;">
                <h3 class="form-title"><i class="fas fa-edit"></i> Adicionar/Editar Item</h3>
                <div class="form-group">
                    <label for="txtItem">Nome do Item</label>
                    <input type="text" id="txtItem" placeholder="Ex: Arroz integral">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="txtQtd">Quantidade</label>
                        <input type="number" id="txtQtd" min="1" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="txtValor">Valor (R$)</label>
                        <input type="number" id="txtValor" step="0.01" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="txtMes">Mês</label>
                        <select id="txtMes">
                            <!-- Meses serão adicionados dinamicamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="txtCat">Categoria</label>
                        <select id="txtCat">
                            <!-- Categorias serão adicionadas dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-success" onclick="salvarItem()">
                        <i class="fas fa-save"></i> Salvar Item
                    </button>
                    <button class="btn btn-secondary" onclick="cancelar()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>

            <div id="categorias-container" style="display:none;">
                <h3 class="form-title"><i class="fas fa-tags"></i> Gerenciar Categorias</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="novaCategoria">Nova Categoria</label>
                        <input type="text" id="novaCategoria" placeholder="Digite o nome da categoria">
                    </div>
                    
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="adicionarCategoria()" style="height: 39px;">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Categorias Existentes</label>
                    <div class="categorias-list" id="listaCategorias">
                        <!-- Categorias serão adicionadas dinamicamente -->
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-success" onclick="salvarCategorias()">
                        <i class="fas fa-check"></i> Concluído
                    </button>
                </div>
            </div>

            <div id="lista">
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>Sua lista está vazia</h3>
                    <p>Adicione itens para começar a organizar suas compras!</p>
                </div>
            </div>

            <div class="total-container" id="totalContainer">
                <span>Total da lista: R$ <span id="totalValue">0.00</span></span>
            </div>
        </div>

        <!-- TAB 2: RELATÓRIOS -->
        <div id="relatorios-tab" class="tab-content">
            <div class="relatorios-container">
                <h3 class="form-title"><i class="fas fa-chart-bar"></i> Relatórios e Comparativos</h3>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="mesComparativo1">Mês 1</label>
                        <select id="mesComparativo1">
                            <option value="">Selecione um mês</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="mesComparativo2">Mês 2</label>
                        <select id="mesComparativo2">
                            <option value="">Selecione um mês</option>
                        </select>
                    </div>
                    
                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="atualizarRelatorios()" style="height: 39px;">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                
                <div class="resumo-container" id="resumoComparativo">
                    <!-- Resumo comparativo será gerado aqui -->
                </div>
                
                <div class="graficos-container">
                    <div class="grafico-card">
                        <h3>Gastos por Categoria</h3>
                        <canvas id="graficoCategorias"></canvas>
                    </div>
                    
                    <div class="grafico-card">
                        <h3>Comparativo Mensal</h3>
                        <canvas id="graficoMensal"></canvas>
                    </div>
                    
                    <div class="grafico-card">
                        <h3>Top 5 Itens Mais Caros</h3>
                        <canvas id="graficoTopItens"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: IMPORTAR/EXPORTAR -->
        <div id="import-export-tab" class="tab-content">
            <div class="relatorios-container">
                <h3 class="form-title"><i class="fas fa-file-export"></i> Exportar Dados</h3>
                
                <div class="buttons">
                    <button class="btn btn-success" onclick="exportarParaExcel()">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                    <button class="btn btn-warning" onclick="exportarParaCSV()">
                        <i class="fas fa-file-csv"></i> Exportar para CSV
                    </button>
                    <button class="btn btn-info" onclick="copiarParaClipboard()">
                        <i class="fas fa-copy"></i> Copiar Dados
                    </button>
                </div>
                
                <div class="file-input-container" id="dropArea" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)" 
                     ondrop="handleDrop(event)">
                    <label class="file-input-label" for="fileInput">
                        <i class="fas fa-file-import"></i>
                        <span>Arraste e solte um arquivo Excel aqui ou clique para selecionar</span>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleFileSelect(event)">
                    </label>
                    <p class="file-info">Formatos suportados: Excel (.xlsx, .xls) e CSV</p>
                </div>
                
                <div class="form-group">
                    <h4>Modelo do Arquivo Excel</h4>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Seu arquivo Excel deve conter as seguintes colunas:<br>
                        <strong>Item</strong> (nome do produto), <strong>Quantidade</strong> (número), 
                        <strong>Valor</strong> (número), <strong>Mês</strong> (texto), <strong>Categoria</strong> (texto)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let itens = [];
        let categorias = ["Alimentos", "Limpeza", "Higiene", "Bebidas", "Padaria"];
        let meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                     "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        let editIndex = -1;
        let graficoCategorias, graficoMensal, graficoTopItens;

        // FUNÇÕES DE NAVEGAÇÃO
        function abrirTab(tabId) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar a tab selecionada
            document.getElementById(tabId).classList.add('active');
            
            // Ativar o botão correspondente
            document.querySelector(`[onclick="abrirTab('${tabId}')"]`).classList.add('active');
            
            // Se for a tab de relatórios, atualizar os gráficos
            if (tabId === 'relatorios-tab') {
                setTimeout(atualizarRelatorios, 100);
            }
        }

        // INICIALIZAÇÃO
        function inicializarCategorias() {
            // Atualizar filtro de categorias
            const filtroCat = document.getElementById("filtroCat");
            filtroCat.innerHTML = '<option value="Tudo">Todas as categorias</option>';
            
            // Atualizar seletor de categorias no formulário
            const txtCat = document.getElementById("txtCat");
            txtCat.innerHTML = '';
            
            categorias.forEach(cat => {
                // Adicionar ao filtro
                const optFiltro = document.createElement("option");
                optFiltro.value = cat;
                optFiltro.textContent = cat;
                filtroCat.appendChild(optFiltro);
                
                // Adicionar ao formulário
                const optForm = document.createElement("option");
                optForm.value = cat;
                optForm.textContent = cat;
                txtCat.appendChild(optForm);
            });
            
            // Atualizar lista visual de categorias
            atualizarListaCategorias();
        }

        function inicializarMeses() {
            // Preencher meses no filtro
            const filtroMes = document.getElementById("filtroMes");
            const mesesComparativo1 = document.getElementById("mesComparativo1");
            const mesesComparativo2 = document.getElementById("mesComparativo2");
            const txtMes = document.getElementById("txtMes");
            
            // Limpar selects
            mesesComparativo1.innerHTML = '<option value="">Selecione um mês</option>';
            mesesComparativo2.innerHTML = '<option value="">Selecione um mês</option>';
            txtMes.innerHTML = '<option value="">Selecione um mês</option>';
            
            meses.forEach(m => {
                // Adicionar ao filtro principal
                const optFiltro = document.createElement("option");
                optFiltro.value = m;
                optFiltro.textContent = m;
                filtroMes.appendChild(optFiltro);
                
                // Adicionar aos selects de comparação
                const optComp1 = document.createElement("option");
                optComp1.value = m;
                optComp1.textContent = m;
                mesesComparativo1.appendChild(optComp1);
                
                const optComp2 = document.createElement("option");
                optComp2.value = m;
                optComp2.textContent = m;
                mesesComparativo2.appendChild(optComp2);
                
                // Adicionar ao formulário
                const optForm = document.createElement("option");
                optForm.value = m;
                optForm.textContent = m;
                txtMes.appendChild(optForm);
            });
        }

        function atualizarListaCategorias() {
            const listaCategorias = document.getElementById("listaCategorias");
            listaCategorias.innerHTML = '';
            
            categorias.forEach((cat, index) => {
                const tag = document.createElement("span");
                tag.className = "categoria-tag";
                tag.innerHTML = `
                    ${cat}
                    <button class="remove-cat" onclick="removerCategoria(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                listaCategorias.appendChild(tag);
            });
        }

        // FUNÇÕES DE CATEGORIAS
        function mostrarGerenciarCategorias() {
            document.getElementById("categorias-container").style.display = "block";
            document.getElementById("formulario").style.display = "none";
        }

        function adicionarCategoria() {
            const novaCategoriaInput = document.getElementById("novaCategoria");
            const novaCategoria = novaCategoriaInput.value.trim();
            
            if (!novaCategoria) {
                alert("Por favor, digite o nome da categoria.");
                novaCategoriaInput.focus();
                return;
            }
            
            if (categorias.includes(novaCategoria)) {
                alert("Esta categoria já existe!");
                novaCategoriaInput.focus();
                return;
            }
            
            categorias.push(novaCategoria);
            inicializarCategorias();
            novaCategoriaInput.value = "";
            novaCategoriaInput.focus();
        }

        function removerCategoria(index) {
            if (categorias.length <= 1) {
                alert("Você precisa ter pelo menos uma categoria!");
                return;
            }
            
            const categoriaRemovida = categorias[index];
            
            // Verificar se há itens usando esta categoria
            const itensComCategoria = itens.filter(item => item.cat === categoriaRemovida);
            
            if (itensComCategoria.length > 0) {
                if (!confirm(`Existem ${itensComCategoria.length} item(s) com a categoria "${categoriaRemovida}". Ao remover esta categoria, esses itens serão movidos para a primeira categoria disponível. Deseja continuar?`)) {
                    return;
                }
                
                // Mover itens para a primeira categoria disponível
                const novaCategoria = categorias.filter((_, i) => i !== index)[0];
                itens.forEach(item => {
                    if (item.cat === categoriaRemovida) {
                        item.cat = novaCategoria;
                    }
                });
            }
            
            categorias.splice(index, 1);
            inicializarCategorias();
            mostrarItens();
        }

        function salvarCategorias() {
            document.getElementById("categorias-container").style.display = "none";
            localStorage.setItem('listaComprasCategorias', JSON.stringify(categorias));
        }

        // FUNÇÕES DE ITENS
        function mostrarFormulario(it = null, i = null) {
            document.getElementById("formulario").style.display = "block";
            document.getElementById("categorias-container").style.display = "none";
            
            if (it) {
                editIndex = i;
                document.getElementById("txtItem").value = it.item;
                document.getElementById("txtQtd").value = it.qtd;
                document.getElementById("txtValor").value = it.valor;
                document.getElementById("txtMes").value = it.mes;
                document.getElementById("txtCat").value = it.cat;
            } else {
                editIndex = -1;
                document.getElementById("txtItem").value = "";
                document.getElementById("txtQtd").value = "1";
                document.getElementById("txtValor").value = "";
                document.getElementById("txtMes").value = meses[0] || "";
                document.getElementById("txtCat").value = categorias[0];
            }
            document.getElementById("txtItem").focus();
        }

        function cancelar() {
            editIndex = -1;
            document.getElementById("formulario").style.display = "none";
            document.getElementById("categorias-container").style.display = "none";
        }

        function salvarItem() {
            let item = document.getElementById("txtItem").value.trim();
            let qtd = document.getElementById("txtQtd").value;
            let valor = document.getElementById("txtValor").value;
            let mes = document.getElementById("txtMes").value.trim();
            let cat = document.getElementById("txtCat").value;

            if (!item) {
                alert("Por favor, informe o nome do item.");
                document.getElementById("txtItem").focus();
                return;
            }

            if (!qtd || qtd <= 0) {
                alert("Por favor, informe uma quantidade válida.");
                document.getElementById("txtQtd").focus();
                return;
            }

            if (!valor || valor <= 0) {
                alert("Por favor, informe um valor válido.");
                document.getElementById("txtValor").focus();
                return;
            }

            if (!mes) {
                alert("Por favor, informe o mês.");
                document.getElementById("txtMes").focus();
                return;
            }

            if (editIndex >= 0) {
                itens[editIndex] = { item, qtd, valor, mes, cat };
                editIndex = -1;
            } else {
                itens.push({ item, qtd, valor, mes, cat });
            }

            document.getElementById("formulario").style.display = "none";
            mostrarItens();
            salvarDados();
        }

        function mostrarItens() {
            let mes = document.getElementById("filtroMes").value;
            let cat = document.getElementById("filtroCat").value;

            let html = "";
            let total = 0;
            let count = 0;

            itens.forEach((it, i) => {
                if ((mes === "" || it.mes === mes) && (cat === "Tudo" || it.cat === cat)) {
                    const itemTotal = it.qtd * it.valor;
                    total += itemTotal;
                    count++;

                    const categoriaIndex = categorias.indexOf(it.cat);
                    const colors = ["#4a6ee0", "#2ed573", "#ffa502", "#ff4757", "#8e44ad", "#00d2d3", "#ff9ff3", "#54a0ff", "#5f27cd"];
                    const borderColor = colors[categoriaIndex % colors.length];

                    html += `
                    <div class="card" style="border-left-color: ${borderColor}">
                        <div class="card-header">
                            <span class="item-name">${it.item}</span>
                            <span class="item-category" style="background-color: ${borderColor}20; color: ${borderColor}">${it.cat}</span>
                        </div>
                        
                        <div class="item-details">
                            <div class="detail">
                                <i class="fas fa-hashtag"></i>
                                <span>${it.qtd} un</span>
                            </div>
                            <div class="detail">
                                <i class="fas fa-dollar-sign"></i>
                                <span>R$ ${parseFloat(it.valor).toFixed(2)}</span>
                            </div>
                            <div class="detail">
                                <i class="fas fa-calculator"></i>
                                <span>R$ ${itemTotal.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div class="item-month">${it.mes}</div>
                        
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editar(${i})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluir(${i})">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>`;
                }
            });

            document.getElementById("lista").innerHTML = html;
            
            const emptyState = document.getElementById("emptyState");
            const totalContainer = document.getElementById("totalContainer");
            
            if (count === 0) {
                emptyState.style.display = "block";
                totalContainer.style.display = "none";
            } else {
                emptyState.style.display = "none";
                totalContainer.style.display = "block";
                document.getElementById("totalValue").textContent = total.toFixed(2);
            }
        }

        function editar(i) {
            mostrarFormulario(itens[i], i);
        }

        function excluir(i) {
            if (confirm("Tem certeza que deseja excluir este item?")) {
                itens.splice(i, 1);
                mostrarItens();
                salvarDados();
            }
        }

        // FUNÇÕES DE RELATÓRIOS
        function atualizarRelatorios() {
            const mes1 = document.getElementById("mesComparativo1").value;
            const mes2 = document.getElementById("mesComparativo2").value;
            
            // Atualizar resumo comparativo
            atualizarResumoComparativo(mes1, mes2);
            
            // Atualizar gráficos
            atualizarGraficos(mes1, mes2);
        }

        function atualizarResumoComparativo(mes1, mes2) {
            const resumoComparativo = document.getElementById("resumoComparativo");
            let html = '';
            
            // Calcular totais
            const totalMes1 = mes1 ? calcularTotalPorMes(mes1) : 0;
            const totalMes2 = mes2 ? calcularTotalPorMes(mes2) : 0;
            const totalGeral = calcularTotalGeral();
            const mediaMensal = calcularMediaMensal();
            
            // Resumo do mês 1
            if (mes1) {
                html += `
                <div class="resumo-card">
                    <h4>Total ${mes1}</h4>
                    <div class="valor">R$ ${totalMes1.toFixed(2)}</div>
                    <div class="detalhe">${contarItensPorMes(mes1)} itens</div>
                </div>`;
            }
            
            // Resumo do mês 2
            if (mes2) {
                html += `
                <div class="resumo-card">
                    <h4>Total ${mes2}</h4>
                    <div class="valor">R$ ${totalMes2.toFixed(2)}</div>
                    <div class="detalhe">${contarItensPorMes(mes2)} itens</div>
                </div>`;
            }
            
            // Comparativo
            if (mes1 && mes2) {
                const diferenca = totalMes2 - totalMes1;
                const percentual = totalMes1 > 0 ? (diferenca / totalMes1 * 100) : 0;
                
                html += `
                <div class="resumo-card">
                    <h4>Variação</h4>
                    <div class="valor" style="color: ${diferenca >= 0 ? '#2ed573' : '#ff4757'}">
                        ${diferenca >= 0 ? '+' : ''}R$ ${Math.abs(diferenca).toFixed(2)}
                    </div>
                    <div class="detalhe">${percentual >= 0 ? '+' : ''}${percentual.toFixed(1)}%</div>
                </div>`;
            }
            
            // Resumo geral
            html += `
            <div class="resumo-card">
                <h4>Total Geral</h4>
                <div class="valor">R$ ${totalGeral.toFixed(2)}</div>
                <div class="detalhe">${itens.length} itens</div>
            </div>
            
            <div class="resumo-card">
                <h4>Média Mensal</h4>
                <div class="valor">R$ ${mediaMensal.toFixed(2)}</div>
                <div class="detalhe">${mesesComDados().length} meses</div>
            </div>`;
            
            resumoComparativo.innerHTML = html;
        }

        function atualizarGraficos(mes1, mes2) {
            // Gráfico de categorias
            atualizarGraficoCategorias(mes1, mes2);
            
            // Gráfico mensal
            atualizarGraficoMensal();
            
            // Gráfico de top itens
            atualizarGraficoTopItens(mes1, mes2);
        }

        function atualizarGraficoCategorias(mes1, mes2) {
            const ctx = document.getElementById('graficoCategorias').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (graficoCategorias) {
                graficoCategorias.destroy();
            }
            
            // Preparar dados
            const labels = categorias;
            const dataMes1 = mes1 ? categorias.map(cat => calcularTotalPorCategoriaEMes(cat, mes1)) : [];
            const dataMes2 = mes2 ? categorias.map(cat => calcularTotalPorCategoriaEMes(cat, mes2)) : [];
            
            const datasets = [];
            
            if (mes1) {
                datasets.push({
                    label: mes1,
                    data: dataMes1,
                    backgroundColor: 'rgba(74, 110, 224, 0.7)',
                    borderColor: 'rgba(74, 110, 224, 1)',
                    borderWidth: 1
                });
            }
            
            if (mes2) {
                datasets.push({
                    label: mes2,
                    data: dataMes2,
                    backgroundColor: 'rgba(46, 213, 115, 0.7)',
                    borderColor: 'rgba(46, 213, 115, 1)',
                    borderWidth: 1
                });
            }
            
            // Se nenhum mês selecionado, mostrar geral
            if (!mes1 && !mes2) {
                const dataGeral = categorias.map(cat => calcularTotalPorCategoria(cat));
                datasets.push({
                    label: 'Total por Categoria',
                    data: dataGeral,
                    backgroundColor: 'rgba(74, 110, 224, 0.7)',
                    borderColor: 'rgba(74, 110, 224, 1)',
                    borderWidth: 1
                });
            }
            
            graficoCategorias = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function atualizarGraficoMensal() {
            const ctx = document.getElementById('graficoMensal').getContext('2d');
            
            if (graficoMensal) {
                graficoMensal.destroy();
            }
            
            const mesesComDadosArray = mesesComDados();
            const totaisMensais = mesesComDadosArray.map(mes => calcularTotalPorMes(mes));
            
            graficoMensal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mesesComDadosArray,
                    datasets: [{
                        label: 'Gastos Mensais',
                        data: totaisMensais,
                        backgroundColor: 'rgba(74, 110, 224, 0.2)',
                        borderColor: 'rgba(74, 110, 224, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function atualizarGraficoTopItens(mes1, mes2) {
            const ctx = document.getElementById('graficoTopItens').getContext('2d');
            
            if (graficoTopItens) {
                graficoTopItens.destroy();
            }
            
            // Filtrar itens pelos meses selecionados
            let itensFiltrados = itens;
            if (mes1 || mes2) {
                const mesesSelecionados = [];
                if (mes1) mesesSelecionados.push(mes1);
                if (mes2) mesesSelecionados.push(mes2);
                
                itensFiltrados = itens.filter(item => mesesSelecionados.includes(item.mes));
            }
            
            // Calcular totais por item
            const itensComTotal = itensFiltrados.map(item => ({
                nome: item.item,
                total: item.qtd * item.valor,
                categoria: item.cat
            }));
            
            // Ordenar por total e pegar top 5
            const topItens = itensComTotal
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            graficoTopItens = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topItens.map(item => item.nome),
                    datasets: [{
                        data: topItens.map(item => item.total),
                        backgroundColor: [
                            'rgba(74, 110, 224, 0.7)',
                            'rgba(46, 213, 115, 0.7)',
                            'rgba(255, 165, 2, 0.7)',
                            'rgba(255, 71, 87, 0.7)',
                            'rgba(142, 68, 173, 0.7)'
                        ],
                        borderColor: [
                            'rgba(74, 110, 224, 1)',
                            'rgba(46, 213, 115, 1)',
                            'rgba(255, 165, 2, 1)',
                            'rgba(255, 71, 87, 1)',
                            'rgba(142, 68, 173, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `R$ ${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // FUNÇÕES DE CÁLCULO
        function calcularTotalPorMes(mes) {
            return itens
                .filter(item => item.mes === mes)
                .reduce((total, item) => total + (item.qtd * item.valor), 0);
        }

        function calcularTotalPorCategoria(categoria) {
            return itens
                .filter(item => item.cat === categoria)
                .reduce((total, item) => total + (item.qtd * item.valor), 0);
        }

        function calcularTotalPorCategoriaEMes(categoria, mes) {
            return itens
                .filter(item => item.cat === categoria && item.mes === mes)
                .reduce((total, item) => total + (item.qtd * item.valor), 0);
        }

        function calcularTotalGeral() {
            return itens.reduce((total, item) => total + (item.qtd * item.valor), 0);
        }

        function calcularMediaMensal() {
            const mesesComDadosArray = mesesComDados();
            if (mesesComDadosArray.length === 0) return 0;
            
            const totalMensal = mesesComDadosArray.reduce((total, mes) => total + calcularTotalPorMes(mes), 0);
            return totalMensal / mesesComDadosArray.length;
        }

        function contarItensPorMes(mes) {
            return itens.filter(item => item.mes === mes).length;
        }

        function mesesComDados() {
            const mesesSet = new Set(itens.map(item => item.mes));
            return Array.from(mesesSet).sort((a, b) => meses.indexOf(a) - meses.indexOf(b));
        }

        // FUNÇÕES DE EXPORTAÇÃO/IMPORTAÇÃO
        function exportarParaExcel() {
            try {
                // Preparar dados para exportação
                const dadosExportacao = itens.map(item => ({
                    Item: item.item,
                    Quantidade: item.qtd,
                    Valor: item.valor,
                    Total: (item.qtd * item.valor).toFixed(2),
                    Mês: item.mes,
                    Categoria: item.cat
                }));
                
                // Adicionar linha de total
                const totalGeral = calcularTotalGeral();
                dadosExportacao.push({
                    Item: 'TOTAL GERAL',
                    Quantidade: '',
                    Valor: '',
                    Total: totalGeral.toFixed(2),
                    Mês: '',
                    Categoria: ''
                });
                
                // Criar worksheet
                const ws = XLSX.utils.json_to_sheet(dadosExportacao);
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Lista de Compras");
                
                // Gerar arquivo Excel
                const nomeArquivo = `lista_compras_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, nomeArquivo);
                
                alert(`Arquivo ${nomeArquivo} exportado com sucesso!`);
            } catch (error) {
                alert('Erro ao exportar para Excel: ' + error.message);
            }
        }

        function exportarParaCSV() {
            try {
                // Preparar dados CSV
                let csv = "Item,Quantidade,Valor,Total,Mês,Categoria\n";
                
                itens.forEach(item => {
                    const total = (item.qtd * item.valor).toFixed(2);
                    csv += `"${item.item}",${item.qtd},${item.valor},${total},"${item.mes}","${item.cat}"\n`;
                });
                
                // Adicionar linha de total
                const totalGeral = calcularTotalGeral();
                csv += `"TOTAL GERAL","","",${totalGeral.toFixed(2)},"",""\n`;
                
                // Criar blob e download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                link.setAttribute("href", url);
                link.setAttribute("download", `lista_compras_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Arquivo CSV exportado com sucesso!');
            } catch (error) {
                alert('Erro ao exportar para CSV: ' + error.message);
            }
        }

        function copiarParaClipboard() {
            try {
                // Preparar texto formatado
                let texto = "LISTA DE COMPRAS\n\n";
                
                itens.forEach(item => {
                    const total = (item.qtd * item.valor).toFixed(2);
                    texto += `${item.item} - ${item.qtd} x R$ ${item.valor} = R$ ${total} (${item.mes} - ${item.cat})\n`;
                });
                
                texto += `\nTOTAL GERAL: R$ ${calcularTotalGeral().toFixed(2)}\n`;
                
                // Copiar para clipboard
                navigator.clipboard.writeText(texto)
                    .then(() => alert('Dados copiados para a área de transferência!'))
                    .catch(() => {
                        // Fallback para navegadores antigos
                        const textarea = document.createElement('textarea');
                        textarea.value = texto;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        alert('Dados copiados para a área de transferência!');
                    });
            } catch (error) {
                alert('Erro ao copiar dados: ' + error.message);
            }
        }

        // FUNÇÕES DE IMPORTAR
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropArea').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropArea').classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropArea').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processarArquivo(files[0]);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processarArquivo(files[0]);
            }
        }

        function processarArquivo(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Pegar a primeira planilha
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Processar os dados
                    const novosItens = jsonData
                        .filter(row => row.Item && row.Item !== 'TOTAL GERAL')
                        .map(row => {
                            // Tentar encontrar os dados em diferentes formatos de coluna
                            const item = row.Item || row.item || row['Nome do Item'] || '';
                            const qtd = parseFloat(row.Quantidade || row.qtd || row.quantidade || row.Qtd || 1);
                            const valor = parseFloat(row.Valor || row.valor || row.preco || row.Preço || 0);
                            const mes = row.Mês || row.mes || row.Mes || row['Período'] || 'Indefinido';
                            const cat = row.Categoria || row.categoria || row.Cat || row['Categoria'] || 'Outros';
                            
                            return {
                                item: item.toString(),
                                qtd: isNaN(qtd) ? 1 : qtd,
                                valor: isNaN(valor) ? 0 : valor,
                                mes: mes.toString(),
                                cat: cat.toString()
                            };
                        })
                        .filter(item => item.item && item.item.trim() !== '');
                    
                    if (novosItens.length === 0) {
                        alert('Nenhum item válido encontrado no arquivo.');
                        return;
                    }
                    
                    // Perguntar se quer substituir ou adicionar
                    if (confirm(`Encontrados ${novosItens.length} itens no arquivo. Deseja adicionar à lista atual? (Cancelar para substituir)`)) {
                        // Adicionar à lista existente
                        itens.push(...novosItens);
                    } else {
                        // Substituir lista
                        itens = novosItens;
                    }
                    
                    // Atualizar categorias automaticamente
                    const novasCategorias = [...new Set([...categorias, ...novosItens.map(item => item.cat)])];
                    if (novasCategorias.length > categorias.length) {
                        categorias = novasCategorias;
                        inicializarCategorias();
                    }
                    
                    mostrarItens();
                    salvarDados();
                    alert(`Importação concluída! ${novosItens.length} itens processados.`);
                    
                } catch (error) {
                    alert('Erro ao processar o arquivo: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Erro ao ler o arquivo.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // FUNÇÕES AUXILIARES
        function salvarDados() {
            localStorage.setItem('listaComprasItens', JSON.stringify(itens));
            localStorage.setItem('listaComprasCategorias', JSON.stringify(categorias));
        }

        // CARREGAR DADOS INICIAIS
        window.onload = function() {
            // Carregar categorias
            const categoriasSalvas = localStorage.getItem('listaComprasCategorias');
            if (categoriasSalvas) {
                categorias = JSON.parse(categoriasSalvas);
            }
            
            // Carregar itens
            const itensSalvos = localStorage.getItem('listaComprasItens');
            if (itensSalvos) {
                itens = JSON.parse(itensSalvos);
            } else {
                // Itens de exemplo
                itens = [
                    { item: "Arroz Integral", qtd: 2, valor: 8.50, mes: "Janeiro", cat: "Alimentos" },
                    { item: "Sabão em Pó", qtd: 1, valor: 12.90, mes: "Janeiro", cat: "Limpeza" },
                    { item: "Shampoo", qtd: 2, valor: 15.75, mes: "Fevereiro", cat: "Higiene" },
                    { item: "Feijão Carioca", qtd: 3, valor: 6.80, mes: "Janeiro", cat: "Alimentos" },
                    { item: "Café", qtd: 1, valor: 9.90, mes: "Janeiro", cat: "Bebidas" },
                    { item: "Pão de Forma", qtd: 2, valor: 7.50, mes: "Fevereiro", cat: "Padaria" },
                    { item: "Detergente", qtd: 2, valor: 3.20, mes: "Março", cat: "Limpeza" },
                    { item: "Creme Dental", qtd: 1, valor: 5.80, mes: "Março", cat: "Higiene" },
                    { item: "Leite", qtd: 4, valor: 4.20, mes: "Fevereiro", cat: "Alimentos" },
                    { item: "Refrigerante", qtd: 2, valor: 6.50, mes: "Março", cat: "Bebidas" }
                ];
            }
            
            inicializarCategorias();
            inicializarMeses();
            mostrarItens();
        };
    </script>
</body>
</html>